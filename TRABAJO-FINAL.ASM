;SEMESTRE 2012-2
;PROGRAMA REALIZADO POR: NICHOLLS
;COMUNICACION SERIAL
;TRANSMITIR CADENA DE CARACTERES POR EL PUERTO SERIAL

        .MODEL  SMALL
        .386
        .STACK
        .DATA

  
;*************ZONA DE DECLARACION DE LAS VARIABLES****************
SALTO	DB    10,13,'$'
MENU1 DB 	  'Si desea cambiar el código de seguridad presione la tecla 1.',10,13,'$'
MENU2 DB 	  'Si desea cambiar el tiempo de espera de la aula 1 presione la tecla 2.',10,13,'$'
MENU3 DB 	  'Si desea cambiar el tiempo de espera de la aula 2 presione la tecla 3.',10,13,'$'
MENU4 DB 	  'AULA 1',10,13,'$'
MENU5 DB 	  'AULA 2',10,13,'$'
MENU6 DB 	  'LUZ:ON',10,13,'$'
MENU7 DB 	  'LUZ:OFF',10,13,'$'
MENU8 DB	  'SEGURIDAD:ON',10,13,'$'
MENU9 DB	  'SEGURIDAD:OFF',10,13,'$'
MENU10 DB	  'MOVIMIENTO:ON',10,13,'$'
MENU11 DB	  'MOVIMIENTO:OFF',10,13,'$'
MENU12 DB	  'ALARMA:ON',10,13,'$'
MENU13 DB	  'ALARMA:OFF',10,13,'$'
INICIO1 DB 	  'Ingrese codigo de seguridad',10,13,'$'
INICIO2 DB 	  'HORARIOS DE CLASE',10,13,'$'
INICIO3 DB 	  '0. Clase 6:00am - 8:00am',10,13,'$'
INICIO4 DB 	  '1. Clase 8:00am - 10:00am',10,13,'$'
INICIO5 DB 	  '2. Clase 10:00am - 12:00pm',10,13,'$'
INICIO6 DB 	  '3. Clase 12:00pm - 14:00pm',10,13,'$'
INICIO7 DB 	  '4. Clase 14:00pm - 16:00pm',10,13,'$'
INICIO8 DB 	  '5. Clase 16:00pm - 18:00pm',10,13,'$'
INICIO9 DB 	  '6. Clase 18:00pm - 20:00pm',10,13,'$'
INICIO10 DB   '7. Clase 20:00pm - 22:00pm',10,13,'$'
INICIO11 DB   'Seleccione los horarios de las clases para el aula 1, para finalizar presione enter',10,13,'$'
INICIO12 DB   'Seleccione los horarios de las clases para el aula 2, para finalizar presione enter',10,13,'$'
INICIO13 DB	  'Ingrese horas del tiempo de espera para el aula 1',10,13,'$'
INICIO14 DB	  'Ingrese minutos del tiempo de espera para el aula 1',10,13,'$'
INICIO15 DB	  'Ingrese segundos del tiempo de espera para el aula 1',10,13,'$'
INICIO16 DB	  'Ingrese horas del tiempo de espera para el aula 2',10,13,'$'
INICIO17 DB	  'Ingrese minutos del tiempo de espera para el aula 2',10,13,'$'
INICIO18 DB	  'Ingrese segundos del tiempo de espera para el aula 2',10,13,'$'
TITULO DB 	  'AUTOMATIZACION LABORATORIO',10,13,'$'

HORCLAS1 DB '06-08:CLASE',10,13,'$'
HORCLAS2 DB '08-10:CLASE',10,13,'$'
HORCLAS3 DB '10-12:CLASE',10,13,'$'
HORCLAS4 DB '12-14:CLASE',10,13,'$'
HORCLAS5 DB '14-16:CLASE',10,13,'$'
HORCLAS6 DB '16-18:CLASE',10,13,'$'
HORCLAS7 DB '18-20:CLASE',10,13,'$'
HORCLAS8 DB '20-22:CLASE',10,13,'$'

HORNODIS1 DB '06-08:NO DISPONIBLE',10,13,'$'
HORNODIS2 DB '08-10:NO DISPONIBLE',10,13,'$'
HORNODIS3 DB '10-12:NO DISPONIBLE',10,13,'$'
HORNODIS4 DB '12-14:NO DISPONIBLE',10,13,'$'
HORNODIS5 DB '14-16:NO DISPONIBLE',10,13,'$'
HORNODIS6 DB '16-18:NO DISPONIBLE',10,13,'$'
HORNODIS7 DB '18-20:NO DISPONIBLE',10,13,'$'
HORNODIS8 DB '20-22:NO DISPONIBLE',10,13,'$'

HSISTEMA  DB  3 DUP(00),'$'
CODIGO DB 6 DUP(00H) ;ESTE ES EL CODIGO DE SEGURIDAD
AULA1 DB 9 DUP(30H) ;VECTOR HORARIOS DE CLASE PREDEFINIDOS
AULA2 DB 9 DUP(30H)
HORA1 DB 06,00,00,08,00,00,'$'
HORA2 DB 08,00,00,10,00,00,'$'
HORA3 DB 10,00,00,12,00,00,'$'
HORA4 DB 12,00,00,14,00,00,'$'
HORA5 DB 14,00,00,16,00,00,'$'
HORA6 DB 16,00,00,18,00,00,'$'
HORA7 DB 18,00,00,20,00,00,'$'
HORA8 DB 20,00,00,22,00,00,'$'
ALARMA1 DB 30H ;ALARMA DE SEGURIDAD
ALARMA2 DB 30H
MOVIMIENTO1 DB 30H ;SENSORES DE MOVIMIENTO
MOVIMIENTO2 DB 30H
TIEMPOESPERA1 DB 00,30,00,'$' ;TIEMPO DE ESPERA PARA LA AULAS
TIEMPOESPERA2 DB 00,30,00,'$'
TEMPESPERA1 DB  00,00,00,'$'
TEMPESPERA2 DB  00,00,00,'$'
LUZ1 DB 30H ;ESTADO DE LA LUZ...AULAS
LUZ2 DB 30H
SEGURIDAD1 DB 30H ;ESTADO DE LA SEGURIDAD DE LAS AULAS
SEGURIDAD2 DB 30H
TXDATO DB 60 DUP(' ') ;CADENA A TRANSMITIR
DATO    DB      ?; VARIABLE QUE SE USA PARA LA TRANSMISION AL PIC
RXDATO   DB   00H   ;MEMORIA DONDE SE ALMACENA DATO RECIBIDO
INDICE DW 0
DATO1  DB ' ','$'

;***************ZONA DE CONFIGURACION DE LOS PUERTOS**************
COM1    EQU     3F8H    ;PUERTO SERIAL COM1
MCR     EQU     3FCH    ;REG CONTROL DEL MODEM, BIT1=DTR, BIT0=DSR
LSR     EQU     3FDH    ;REG. ESTADO DE LINEA
MSR     EQU     3FEH    ;REG. ESTADO DEL MODEM

         .CODE
;*****************************************************************
;********* MACROS *******************************************
;MACRO PARA CONFIGURAR PUERTO DE COMNICACION SERIAL
;Y = 0 PARA COM1, = 1 PARA COM2
COM     MACRO   Y
        MOV     AH,00           ;SERVICIO DE CONFIGURACION PUERTO SERIAL
        MOV     AL,11100011B    ;9600 BPS, NO PARIDAD, 1 BIT DE PARADA
        MOV     DX,Y
        INT     14H
        ENDM
		
;****************************************************************
;MACRO PARA VISUALIZAR MENSAJE POR PANTALLA
MENSAJE	MACRO	MENS
	MOV	AH,09H
	MOV	DX,OFFSET MENS
	INT	21H
	ENDM
MOSTRARVECTOR	MACRO NUMAULA
		LOCAL MOS
		MOV SI,0
		MOV CX,8
MOS:	MOV DL,	NUMAULA[SI]
		MOV AH,02   
        INT 21H  
		INC SI	
        LOOP MOS
		ENDM	
;MACRO PARA ENVIAR UNA BANDERA A LA PIC
SENDB  MACRO  K
	MOV    AL,K
	MOV    DATO,AL
	CALL   TX
ENDM
;MACRO PARA ENVIAR UN VECTOR A LA PIC
SEND   MACRO   I,N
		LOCAL  P1
		MOV    SI,I
		MOV    CX,N
P1:		MOV    AL,TXDATO[SI]
        MOV    DATO,AL
		CALL   TX
		INC    SI
		LOOP   P1
ENDM
;****************************************************************


;INICIO DEL PROGRAMA
        ORG     000
        MOV     AX,@DATA
        MOV     DS,AX
		MENSAJE TITULO
        JMP     MAIN
;****************************************************************
		
;****************************************************************
;RUTINA QUE RECIBE UN DATO SERIALMENTE EN AL Y LO ALMACENA EN RXDATO
RX:     PUSHA           ;GUARDAR EN LA PILA TODOS LOS REGISTROS
        MOV     AH,02   ;SERVICIO DE LECTURA POR EL PUERTO SERIAL
        MOV     DX,00   ;SELECCIONAR COM1
        INT     14H
        MOV     RXDATO,AL  ;ALMACENAR DATO RECIBIDO EN RXDATO
        POPA               ;RECUPERAR DE LA PILA TODOS LOS REGISTROS
        RET
;****************************************************************
; RUTINA PARA VISUALIZAR EL DATO RECIBIDO POR PANTALLA
VISUAL:  PUSHA          ;GUARDAR EN LA PILA TODOS LOS REGISTROS
         MOV    AL,RXDATO
         CMP    AL,00H  ;SI NO LLEGA NINGUN CARACTER AL=00H
		 JE		SALIR
		 CMP	AL,'X'
		 JE		MOVIMIENTO11
		 CMP	AL,'Y'
		 JE		MOVIMIENTO22
		 CMP	AL,'A'
		 JE		DEFINIR_ALARMA
		 CMP	AL,'H'
		 JE		DEFINIR_AULA
		 JMP	SALIR
MOVIMIENTO11:
		MOV		MOVIMIENTO1,31H		
		CALL	RX
		MOV		AL,RXDATO
		CMP		AL,'A'
		JE		DEFINIR_ALARMA
		JMP	SALIR
MOVIMIENTO22:
		MOV		MOVIMIENTO2,31H	
		CALL	RX
		MOV		AL,RXDATO
		CMP		AL,'A'
		JE		DEFINIR_ALARMA		
		JMP	SALIR
DEFINIR_ALARMA:
		CALL	RX
		MOV		AL,RXDATO
		CMP		AL,'1'
		JE		DEFINIR_ALARMA1
		CMP		AL,'2'
		JE		DEFINIR_ALARMA2
		JMP		SALIR
DEFINIR_AULA:
		CALL	RX
		MOV		AL,RXDATO
		CMP		AL,'1'
		JE		DEFINIR_AULA1
		CMP		AL,'2'
		JE		DEFINIR_AULA2
		JMP		SALIR
DEFINIR_ALARMA1:
		MOV		ALARMA1,31H
		JMP		SALIR
DEFINIR_ALARMA2:
		MOV		ALARMA2,31H
		JMP		SALIR
DEFINIR_AULA1:
		MOV		SI,INDICE
		MOV		AULA1[SI],31H
		SENDB	'I'
		SENDB	'1'
		MOV		MOVIMIENTO1,31H
		MOV		LUZ1,31H
		MOV		SEGURIDAD1,30H
		JMP		SALIR
DEFINIR_AULA2:
		MOV		SI,INDICE
		MOV		AULA2[SI],31H
		SENDB	'I'
		SENDB	'2'
		MOV		MOVIMIENTO2,31H
		MOV		LUZ2,31H
		MOV		SEGURIDAD2,30H
		JMP		SALIR		
SALIR:   POPA           ;RECUPERAR DE LA PILA TODOS LOS REGISTROS
		 RET
;***********************************************************

; LIMPIAR LA PANTALLA
LIMPIAR:
	MOV AX,0600H
	MOV BH,07H
	MOV CX,0000H
	MOV DX,184FH
	INT 10H ;Interrupcion del BIOS
	mov ah,02h
	mov dx,0
	mov bh,0
	int 10h
	RET			


;SUBRUTINA DE TRANSMISION DE UNA CADENA DE CARACTERES
TX:      PUSHA
         MOV    SI,OFFSET DATO
TXD:     MOV    DX,MCR         
         MOV    AL,00000011B
         OUT    DX,AL
         MOV    DX,MSR          
         MOV    CX,2FFFH
NOLISTO: IN     AL,DX
         AND    AL,00110000B
         CMP    AL,00110000B
         JZ     LISTO
         LOOP   NOLISTO
LISTO:   MOV    DX,LSR          
         MOV    CX,2FFFH        
NVACIO:  IN     AL,DX
         TEST   AL,5
         JNZ     VACIO
         LOOP   NVACIO
VACIO:   MOV    DX,COM1         
         MOV    AL,[SI]
         OUT    DX,AL
		 MOV    RXDATO,AL
         POPA
         RET
;***********************************************************

HORASISTEMA MACRO SISTEMA,INI,F
		LOCAL MOS
		MOV SI,INI
		MOV CX,F
MOS:	MOV AX,0
		MOV AL,SISTEMA[SI]
		AAM
		OR  AX,3030H
		MOV BH,AH
		MOV BL,AL
		MOV	DL, BH
		MOV AH,02   
        INT 21H  
		MOV	DL, BL
		MOV AH,02   
        INT 21H  
		INC SI	
		MOV	DL, '-'
		MOV AH,02   
        INT 21H 
        LOOP MOS
		ENDM		

MOSTRAR	MACRO NUMAULA
		LOCAL MOS,CONOT,CONOT1,FINN,RETORNO,MS0,MS1,MS2,MS3,MS4,MS5,MS6,MS7,MSN0,MSN1,MSN2,MSN3,MSN4,MSN5,MSN6,MSN7
		MOV SI,0
		MOV CX,8
MOS:	 MOV AL,NUMAULA[SI]
		 CMP AL,31H
		 JE	CONOT
		 CMP AL,30H
		 JE CONOT1
		 JMP FINN
		 
CONOT:
		 CMP SI,0
		 JE  MS0
		 CMP SI,1
		 JE  MS1
		 CMP SI,2
		 JE  MS2
		 CMP SI,3
		 JE  MS3
		 CMP SI,4
		 JE  MS4
		 CMP SI,5
		 JE  MS5
		 CMP SI,6
		 JE  MS6
		 CMP SI,7
		 JE  MS7
		 JMP FINN

		 
CONOT1:
		 CMP SI,0
		 JE  MSN0
		 CMP SI,1
		 JE  MSN1
		 CMP SI,2
		 JE  MSN2
		 CMP SI,3
		 JE  MSN3
		 CMP SI,4
		 JE  MSN4
		 CMP SI,5
		 JE  MSN5
		 CMP SI,6
		 JE  MSN6
		 CMP SI,7
		 JE  MSN7
		 JMP FINN
;MENSAJE CUANDO HAY CLASE EN EL HORARIO
MS0:	 MENSAJE HORCLAS1
		 JMP RETORNO
MS1:	 	
		 MENSAJE HORCLAS2
		 JMP RETORNO
MS2:	 	
		 MENSAJE HORCLAS3
		 JMP RETORNO
MS3:	 	
		 MENSAJE HORCLAS4
		 JMP RETORNO
MS4:	 	
		 MENSAJE HORCLAS5
		 JMP RETORNO
MS5:	 	
		 MENSAJE HORCLAS6
		 JMP RETORNO
MS6:	 	
		 MENSAJE HORCLAS7
		 JMP RETORNO
MS7:	 	
		 MENSAJE HORCLAS8
		 JMP RETORNO
;MENSAJE CUANDO NO HAY CLASE EN EL HORARIO
MSN0:	 	
		 MENSAJE HORNODIS1
		 JMP RETORNO
MSN1:	 	
		 MENSAJE HORNODIS2
		 JMP RETORNO
MSN2:	 	
		 MENSAJE HORNODIS3
		 JMP RETORNO
MSN3:	 	
		 MENSAJE HORNODIS4
		 JMP RETORNO
MSN4:	 	
		 MENSAJE HORNODIS5
		 JMP RETORNO
MSN5:	 	
		 MENSAJE HORNODIS6
		 JMP RETORNO
MSN6:	 	
		 MENSAJE HORNODIS7
		 JMP RETORNO
MSN7:	 	
		 MENSAJE HORNODIS8
		 JMP RETORNO
		 
RETORNO: INC SI
		 CMP SI,8
		 JE FINN
		 JMP MOS
FINN:	 MENSAJE SALTO
ENDM

;***********************************************************
LLENAR:			MOV     CX,60
				MOV     SI,0
CICLO_ING:		MOV   	AH,01H
				INT   	21H
				CMP   	AL,0DH   ; COMPARA QUE NO SEA ENTER
				JE    	FINLLEN
				MOV   	TXDATO[SI],AL
				INC   	SI
				LOOP  	CICLO_ING
FINLLEN:		MOV   	AL,'$'
				MOV   	TXDATO[SI],AL
				RET
;***********************************************************
;ASIGNAR EL HORARIO DE CLASES PARA UNA AULA
LLENARHORARIO	MACRO  NUMAULA
				LOCAL  C0,C1,C2,C3,C4,C5,C6,C7,LLENARHORARIO1,COMPARAR,FINLLEN1
LLENARHORARIO1:	MOV   	AH,01H
				INT   	21H
				CMP   	AL,0DH  ; COMPARA QUE NO SEA ENTER
				JE    	FINLLEN1
				JMP		COMPARAR
COMPARAR:		CMP		AL,37H
				JE		C7
				CMP		AL,36H
				JE		C6
				CMP		AL,35H
				JE		C5
				CMP		AL,34H
				JE		C4
			    CMP		AL,33H
				JE		C3
				CMP		AL,32H
				JE		C2
				CMP		AL,31H
				JE		C1
				CMP		AL,30H
				JE		C0
				JMP		LLENARHORARIO1
				
C7:				MOV   	NUMAULA[7],31H
				JMP    	LLENARHORARIO1
C6:				MOV   	NUMAULA[6],31H
				JMP    	LLENARHORARIO1
C5:				MOV   	NUMAULA[5],31H
				JMP    	LLENARHORARIO1
C4:				MOV   	NUMAULA[4],31H
				JMP    	LLENARHORARIO1
C3:				MOV   	NUMAULA[3],31H
				JMP    	LLENARHORARIO1
C2:				MOV   	NUMAULA[2],31H
				JMP    	LLENARHORARIO1
C1:				MOV   	NUMAULA[1],31H
				JMP    	LLENARHORARIO1
C0:				MOV   	NUMAULA[0],31H
				JMP    	LLENARHORARIO1
				
FINLLEN1:		MOV   	AL,'$'
				MOV   	NUMAULA[8],AL		
	ENDM
;***********************************************************
TECLA:   MOV    AH,06           ;CODIGO ASCII DE TECLA SE ALMACENA EN AL
         MOV    DL,0FFH
         INT    21H
         RET
;***********************************************************


;CAPTURA LA HORA Y LA GUARDA EN HSISTEMA
CHORA:	MOV	AH,2CH
		INT	21H
		MOV     DI,0
		MOV     AX,0
        MOV		HSISTEMA[DI],CH     ;HORAS
        INC		DI
        MOV		HSISTEMA[DI],CL		;MINUTOS
        INC		DI
        MOV		HSISTEMA[DI],DH		;SEGUNDOS        
		;HORASISTEMA HSISTEMA
		RET
		
;***********************************************************

VALIDARHORA	MACRO BLOQUE,IND
		LOCAL IGUALINIH,IGUALINIM,MAYORINI,REINICIAR,FINALIZA,IGUALFINH,IGUALFINM,MENORFIN,ENCENDER,ENCENDERIGUALHAU1,ENCENDERIGUALHAU2
		LOCAL ENCENDERIGUALMAU1,ENCENDERIGUALMAU2,MENOR1,L1,SENAL1,MAYOR1,MOVI1,MENOR2,L2,SENAL2,MAYOR2,MOVI2,CAMINO1,CAMINO2		
		;MOV DATO1,'1'
		;MENSAJE DATO1
		CALL	CHORA
		MOV AL,BLOQUE[0]	
		CMP AL,HSISTEMA[0]
		JE  IGUALINIH
		JB  MAYORINI    
		JMP	FINALIZA
IGUALINIH: ;MOV DATO1,'2'
		;MENSAJE DATO1
		CALL	CHORA
		MOV AL,BLOQUE[1]		
		CMP AL,HSISTEMA[1]	
		JE  IGUALINIM
		JB  MAYORINI
		JMP	FINALIZA
IGUALINIM: ;MOV DATO1,'3'
		;MENSAJE DATO1
		CALL	CHORA
		MOV AL,BLOQUE[2]		
		CMP AL,HSISTEMA[2]	
		JBE MAYORINI
		JMP	FINALIZA

MAYORINI: ;MOV DATO1,'4'
		;MENSAJE DATO1
		CALL	CHORA
		MOV AL,BLOQUE[3]   ;LA HORA DEL SISTEMA ES MAYOR A LA HORA DE INICIO DEL BLOQUE ACTUAL		
		CMP AL,HSISTEMA[0]
		JE  IGUALFINH
		JA  MENORFIN
		JMP	FINALIZA
IGUALFINH: ;MOV DATO1,'5'
		;MENSAJE DATO1	
		CALL	CHORA
		MOV AL,BLOQUE[4]		
		CMP AL,HSISTEMA[1]	
		JE  IGUALFINM
		JA  MENORFIN
		JMP	FINALIZA
IGUALFINM: ;MOV DATO1,'6'
		;MENSAJE DATO1
		CALL	CHORA
		MOV AL,BLOQUE[5]		
		CMP AL,HSISTEMA[2]	
		JA MENORFIN
		JMP	FINALIZA
MENORFIN: ;MOV DATO1,'7'   LA HORA DEL SISTEMA ES MENOR A LA HORA DE FINALIZACION DEL BLOQUE ACTUAL
		;MENSAJE DATO1     
		CALL	CHORA
		MOV AX,IND		
		CMP AX,INDICE
		JNE	REINICIAR
		JE	ENCENDER
		JMP	FINALIZA
REINICIAR:	;MOV DATO1,'8'
			;MENSAJE DATO1
			CALL	CHORA
			SENDB   'F'
			SENDB   '1'
			SENDB   'F'
			SENDB   '2'			
			MOV		LUZ1,30H ;ESTADO DE LA LUZ...AULAS EN OFF
			MOV		LUZ2,30H
			MOV		SI,IND
			MOV		INDICE,SI
			MOV		MOVIMIENTO1,30H
			MOV		MOVIMIENTO2,30H
			MOV		SEGURIDAD1,31H
			MOV		SEGURIDAD2,31H
			MOV		AL,BLOQUE[0]
			ADD		AL,TIEMPOESPERA1[0]
			MOV		TEMPESPERA1[0],AL
			MOV		AL,BLOQUE[1]
			ADD		AL,TIEMPOESPERA1[1]
			MOV		TEMPESPERA1[1],AL		
			MOV		AL,BLOQUE[2]
			ADD		AL,TIEMPOESPERA1[2]
			MOV		TEMPESPERA1[2],AL	
			MOV		AL,BLOQUE[0]
			ADD		AL,TIEMPOESPERA2[0]
			MOV		TEMPESPERA2[0],AL
			MOV		AL,BLOQUE[1]
			ADD		AL,TIEMPOESPERA2[1]
			MOV		TEMPESPERA2[1],AL		
			MOV		AL,BLOQUE[2]
			ADD		AL,TIEMPOESPERA2[2]
			MOV		TEMPESPERA2[2],AL	
			;MENSAJE SALTO
			;HORASISTEMA TEMPESPERA1,0,3
			;MENSAJE SALTO
			;HORASISTEMA HSISTEMA,0,3
			;MENSAJE SALTO
			;HORASISTEMA TEMPESPERA2,0,3
			;MENSAJE SALTO
			JMP	FINALIZA
			
ENCENDER:	CALL	CHORA
			;MOV DATO1,'9'
			;MENSAJE DATO1
			MOV AL,HSISTEMA[0]			
			CMP AL,TEMPESPERA1[0]
			JE  ENCENDERIGUALHAU1
			JB  MENOR1
			JA  MAYOR1
ENCENDERIGUALHAU1: CALL	CHORA
			;MOV DATO1,'A'
			;MENSAJE DATO1
			MOV AL,HSISTEMA[1]			
			CMP AL,TEMPESPERA1[1]
			JE  ENCENDERIGUALMAU1
			JB  MENOR1
			JA  MAYOR1	
ENCENDERIGUALHAU2: CALL	CHORA	
			MOV AL,HSISTEMA[1]		
			CMP AL,TEMPESPERA2[1]
			JE  ENCENDERIGUALMAU2
			JB  MENOR2
			JA  MAYOR2
ENCENDERIGUALMAU1: CALL	CHORA
			;MOV DATO1,'B'
			;MENSAJE DATO1
			MOV AL,HSISTEMA[2]			
			CMP AL,TEMPESPERA1[2]
			JB  MENOR1
			JAE  MAYOR1
ENCENDERIGUALMAU2: CALL	CHORA
			MOV AL,HSISTEMA[2]				
			CMP AL,TEMPESPERA2[2]
			JB  MENOR2
			JAE  MAYOR2
			
MENOR1: CALL	CHORA
		;MOV DATO1,'C'
		;MENSAJE DATO1
		MOV	SI,IND		
		MOV	AL,AULA1[SI]
		CMP AL,31H
		JE	L1
		MOV AL,HSISTEMA[0]			
		CMP AL,TEMPESPERA2[0]
		JE  ENCENDERIGUALHAU2
		JB  MENOR2
		JA  MAYOR2
		JMP	FINALIZA
L1:		;MOV DATO1,'D'
		;MENSAJE DATO1
		MOV	AL,LUZ1		
		CMP	AL,30H
		JE	SENAL1
		MOV AL,HSISTEMA[0]			
		CMP AL,TEMPESPERA2[0]
		JE  ENCENDERIGUALHAU2
		JB  MENOR2
		JA  MAYOR2
		JMP	FINALIZA
SENAL1:	;MOV DATO1,'E'
		;MENSAJE DATO1
		SENDB	'I'
		SENDB   '1'
		MOV		LUZ1,31H
		MOV		SEGURIDAD1,30H
		MOV AL,HSISTEMA[0]			
		CMP AL,TEMPESPERA2[0]
		JE  ENCENDERIGUALHAU2
		JB  MENOR2
		JA  MAYOR2
		JMP	FINALIZA
MAYOR1: MOV	AL,MOVIMIENTO1		
		CMP	AL,30H
		JE	MOVI1
		MOV AL,HSISTEMA[0]			
		CMP AL,TEMPESPERA2[0]
		JE  ENCENDERIGUALHAU2
		JB  MENOR2
		JA  MAYOR2
		JMP	FINALIZA
MOVI1:	;MOV DATO1,'G'
		;MENSAJE DATO1
		MOV	AL,LUZ1
		CMP	AL,31H
		JE CAMINO1
		MOV AL,HSISTEMA[0]			
		CMP AL,TEMPESPERA2[0]
		JE  ENCENDERIGUALHAU2
		JB  MENOR2
		JA  MAYOR2
CAMINO1:
		SENDB	'F'
		SENDB	'1'
		MOV		LUZ1,30H
		MOV		SEGURIDAD1,31H		
		MOV AL,HSISTEMA[0]			
		CMP AL,TEMPESPERA2[0]
		JE  ENCENDERIGUALHAU2
		JB  MENOR2
		JA  MAYOR2
		
MENOR2: ;MOV DATO1,'H'
		;MENSAJE DATO1
		MOV	SI,IND
		MOV	AL,AULA2[SI]		
		CMP AL,31H
		JE	L2
		JMP	FINALIZA
		
L2:		;MOV DATO1,'I'
		;MENSAJE DATO1
		MOV	AL,LUZ2
		CMP	AL,30H
		JE	SENAL2
		JMP	FINALIZA
		
SENAL2:	;MOV DATO1,'J'
		;MENSAJE DATO1
		SENDB	'I'
		SENDB	'2'
		MOV		LUZ2,31H
		MOV		SEGURIDAD2,30H
		JMP	FINALIZA	
		
MAYOR2: ;MOV DATO1,'K'
		;MENSAJE DATO1
		MOV	AL,MOVIMIENTO2		
		CMP	AL,30H
		JE	MOVI2
		JMP	FINALIZA
		
MOVI2:	;MOV DATO1,'L'
		;MENSAJE DATO1
		MOV	AL,LUZ2
		CMP	AL,31H
		JE CAMINO2
		JMP	FINALIZA
CAMINO2:
		SENDB	'F'
		SENDB	'2'
		MOV		LUZ2,30H
		MOV		SEGURIDAD2,31H		
FINALIZA:;MOV DATO1,'M'
		;MENSAJE DATO1
		ENDM
;***********************************************************
EVALUAR MACRO 
		LOCAL RETORNO_EVAL,IMPRIMIR1,IMPRIMIR2,IMPRIMIR3,IMPRIMIR4,IMPRIMIR5,IMPRIMIR6,IMPRIMIR7,IMPRIMIR8
		LOCAL NOIMPRIMIR1,NOIMPRIMIR2,NOIMPRIMIR3,NOIMPRIMIR4,NOIMPRIMIR5,NOIMPRIMIR6,NOIMPRIMIR7,NOIMPRIMIR8
		LOCAL CASO2,CASO3,CASO4,CASO5,CASO6,CASO7
		MENSAJE	MENU4
		MOV		AL,MOVIMIENTO1
		CMP		AL,31H
		JE		IMPRIMIR1
		JNE		NOIMPRIMIR1
IMPRIMIR1:
		MENSAJE	MENU10
		JMP		CASO2
NOIMPRIMIR1:
		MENSAJE	MENU11
		JMP		CASO2
CASO2:
		MOV		AL,SEGURIDAD1
		CMP		AL,31H
		JE		IMPRIMIR2
		JNE		NOIMPRIMIR2
IMPRIMIR2:
		MENSAJE	MENU8
		JMP		CASO3
NOIMPRIMIR2:
		MENSAJE	MENU9
		JMP		CASO3
CASO3:
		MOV		AL,LUZ1
		CMP		AL,31H
		JE		IMPRIMIR3
		JNE		NOIMPRIMIR3
IMPRIMIR3:
		MENSAJE	MENU6
		JMP		CASO4
NOIMPRIMIR3:
		MENSAJE	MENU7
		JMP		CASO4
CASO4:
		MOV		AL,ALARMA1
		CMP		AL,31H
		JE		IMPRIMIR4
		JNE		NOIMPRIMIR4
IMPRIMIR4:
		MENSAJE	MENU12
		JMP		EVAL_AULA2
NOIMPRIMIR4:
		MENSAJE	MENU13
		JMP		EVAL_AULA2
EVAL_AULA2:
		MENSAJE	MENU5
		MOV		AL,MOVIMIENTO2
		CMP		AL,31H
		JE		IMPRIMIR5
		JNE		NOIMPRIMIR5
IMPRIMIR5:
		MENSAJE	MENU10
		JMP		CASO5
NOIMPRIMIR5:
		MENSAJE	MENU11
		JMP		CASO5
CASO5:
		MOV		AL,SEGURIDAD2
		CMP		AL,31H
		JE		IMPRIMIR6
		JNE		NOIMPRIMIR6
IMPRIMIR6:
		MENSAJE	MENU8
		JMP		CASO6
NOIMPRIMIR6:
		MENSAJE	MENU9
		JMP		CASO6
CASO6:
		MOV		AL,LUZ2
		CMP		AL,31H
		JE		IMPRIMIR7
		JNE		NOIMPRIMIR7
IMPRIMIR7:
		MENSAJE	MENU6
		JMP		CASO7
NOIMPRIMIR7:
		MENSAJE	MENU7
		JMP		CASO7
CASO7:
		MOV		AL,ALARMA2
		CMP		AL,31H
		JE		IMPRIMIR8
		JNE		NOIMPRIMIR8
IMPRIMIR8:
		MENSAJE	MENU12
		JMP		RETORNO_EVAL
NOIMPRIMIR8:
		MENSAJE	MENU13
		JMP		RETORNO_EVAL
RETORNO_EVAL:		
		ENDM
;***********************************************************
;PROGRAMA PRINCIPAL
MAIN:	COM     00      ;CONFIGURAR PUERTO SERIAL COM1
CODIGOSEG:	MENSAJE INICIO1
		CALL LLENAR	;ESCRIBIR EL MENSAJE A ENVIAR
		SENDB   'C'
		SEND    0,6
		MOV		RXDATO,00H
		CALL    TECLA   ;ESCANEO DE TECLADO
        CMP     AL,1BH  ;TECLA 'ESC' PARA SALIR
		JE      FIN
		JMP     ASIGNARHORARIO			

HORARIO:	
		MENSAJE INICIO2
		MENSAJE INICIO3 
		MENSAJE INICIO4 
		MENSAJE INICIO5 
		MENSAJE INICIO6 
		MENSAJE INICIO7 
		MENSAJE INICIO8 
		MENSAJE INICIO9 
		MENSAJE INICIO10 
		RET
			
ASIGNARHORARIO:	
		CALL HORARIO
		MENSAJE INICIO11
		LLENARHORARIO AULA1
		CALL LIMPIAR
		CALL HORARIO
		MENSAJE INICIO12
		LLENARHORARIO AULA2
		CALL LIMPIAR
		MENSAJE INICIO2
		MENSAJE MENU4		
		MOSTRAR AULA1
		MENSAJE MENU5
		MOSTRAR AULA2		
		CALL CHORA
INFINITO:
		VALIDARHORA HORA1,0
		VALIDARHORA HORA2,1
		VALIDARHORA HORA3,2	
		VALIDARHORA HORA4,3
		VALIDARHORA HORA5,4
		VALIDARHORA HORA6,5	
		VALIDARHORA HORA7,6
		VALIDARHORA HORA8,7
		CALl	RX      ;RECIBIR CARACTER SERIALMENTE
        CALL	VISUAL  ;VISUALIZAR CARACTER RECIBIDO POR PANTALLA
		CALL	LIMPIAR
		;MOSTRAR ESTADOS DE LOS COMPONENTES
		EVALUAR ;MACRO PARA EVALUAR LOS COMPONENTES DE LAS AULAS
		;CAMBIAR LA CLAVE,UNDIR UNA TECLA PARA ESTE MOTIVO
		;CAMBIAR LOS TIEMPOS DE ESPERA CUANDO QUIERA
		;APAGRAR LA ALARMA
		;CUADRAR LOS TIEMPOS PARA QUE NO SE PASEN DE 59 MINUTOS Y SEGUNDOS
		CALL    TECLA   ;ESCANEO DE TECLADO
        CMP     AL,1BH  ;TECLA 'ESC' PARA SALIR
		JE      FIN
		JMP INFINITO

FIN:    MOV     AH,4CH  ;SERVICIO PARA FINALIZAR PROGRAMA
        INT     21H
;***********************************************************

        END

ÿ
ÿ
